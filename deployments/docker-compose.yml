version: "3.9"

x-acecinema-image: &acecinema-image
  image: rangedace/acecinema:latest

services:
  scylla:
    image: scylladb/scylla:5.4
    container_name: acecinema-scylla1
    sysctls:
      fs.aio-max-nr: 1048576
    command: >
      --smp 1 --memory 750M --overprovisioned 1
      --api-address 0.0.0.0
      --listen-address scylla
      --broadcast-address scylla
      --rpc-address 0.0.0.0
      --broadcast-rpc-address scylla
      --seeds scylla,scylla2,scylla3
    volumes:
      - scylla1-data:/var/lib/scylla
    ports:
      - "9042:9042"
      - "10000:10000"
    healthcheck:
      test: ["CMD-SHELL", "nodetool status > /dev/null"]
      interval: 15s
      timeout: 5s
      retries: 10

  scylla2:
    image: scylladb/scylla:5.4
    container_name: acecinema-scylla2
    sysctls:
      fs.aio-max-nr: 1048576
    command: >
      --smp 1 --memory 750M --overprovisioned 1
      --api-address 0.0.0.0
      --listen-address scylla2
      --broadcast-address scylla2
      --rpc-address 0.0.0.0
      --broadcast-rpc-address scylla2
      --seeds scylla,scylla2,scylla3
    depends_on:
      - scylla
    volumes:
      - scylla2-data:/var/lib/scylla
    ports:
      - "9142:9042"
      - "11000:10000"
    healthcheck:
      test: ["CMD-SHELL", "nodetool status > /dev/null"]
      interval: 15s
      timeout: 5s
      retries: 10

  scylla3:
    image: scylladb/scylla:5.4
    container_name: acecinema-scylla3
    sysctls:
      fs.aio-max-nr: 1048576
    command: >
      --smp 1 --memory 750M --overprovisioned 1
      --api-address 0.0.0.0
      --listen-address scylla3
      --broadcast-address scylla3
      --rpc-address 0.0.0.0
      --broadcast-rpc-address scylla3
      --seeds scylla,scylla2,scylla3
    depends_on:
      - scylla
    volumes:
      - scylla3-data:/var/lib/scylla
    ports:
      - "9242:9042"
      - "12000:10000"
    healthcheck:
      test: ["CMD-SHELL", "nodetool status > /dev/null"]
      interval: 15s
      timeout: 5s
      retries: 10

  app:
    <<: *acecinema-image
    container_name: acecinema-app
    restart: unless-stopped
    environment:
      ROLE: api
      NODE_NAME: app1
      APP_PORT: 8080
      SCYLLA_HOSTS: scylla
      SCYLLA_PORT: 9042
      SCYLLA_KEYSPACE: acecinema
      SCYLLA_USER: ""
      SCYLLA_PASSWORD: ""
      APP_SECRET: change-me
      ADMIN_EMAIL: admin@example.com
      ADMIN_PASSWORD: changeme-admin
      MEDIA_ROOT: /mnt/media
    depends_on:
      - scylla
      - scylla2
      - scylla3
    ports:
      - "8080:8080"
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:8080/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3
    volumes:
      - media:/mnt/media:ro

  scanner:
    <<: *acecinema-image
    container_name: acecinema-scanner
    environment:
      ROLE: scanner
      NODE_NAME: scanner
      SCYLLA_HOSTS: scylla,scylla2,scylla3
      SCYLLA_PORT: 9042
      SCYLLA_KEYSPACE: acecinema
      MEDIA_ROOT: /mnt/media
    depends_on:
      - scylla
      - scylla2
      - scylla3
    volumes:
      - media:/mnt/media:ro

volumes:
  scylla1-data: {}
  scylla2-data: {}
  scylla3-data: {}
  media: {}
