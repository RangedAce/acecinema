version: "3.9"

x-acecinema-image: &acecinema-image
  image: rangedace/acecinema:latest

services:
  scylla:
    image: scylladb/scylla:5.4
    container_name: acecinema-scylla1
    privileged: true
    cap_add:
      - SYS_ADMIN
    command: >
      --smp 1 --memory 750M --overprovisioned 1
      --api-address 0.0.0.0
      --listen-address scylla
      --broadcast-address scylla
      --rpc-address 0.0.0.0
      --broadcast-rpc-address scylla
      --seeds scylla
    volumes:
      - scylla1-data:/var/lib/scylla
    ports:
      - "9042:9042"
      - "10000:10000"
    healthcheck:
      test: ["CMD-SHELL", "nodetool status > /dev/null"]
      interval: 15s
      timeout: 5s
      retries: 10

  app:
    <<: *acecinema-image
    container_name: acecinema-app
    restart: unless-stopped
    environment:
      ROLE: api
      NODE_NAME: app1
      APP_PORT: 8080
      SCYLLA_HOSTS: scylla
      SCYLLA_PORT: 9042
      SCYLLA_KEYSPACE: acecinema
      SCYLLA_CONSISTENCY: ONE
      SCYLLA_RF: 1
      SCYLLA_USER: ""
      SCYLLA_PASSWORD: ""
      APP_SECRET: change-me
      ADMIN_EMAIL: admin@example.com
      ADMIN_PASSWORD: changeme-admin
      TMDB_API_KEY: ""
    depends_on:
      - scylla
    ports:
      - "8080:8080"
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:8080/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3
    volumes:
      - /mnt/nfs/media:/mnt/media:ro

  scanner:
    <<: *acecinema-image
    container_name: acecinema-scanner
    environment:
      ROLE: scanner
      NODE_NAME: scanner
      SCYLLA_HOSTS: scylla
      SCYLLA_PORT: 9042
      SCYLLA_KEYSPACE: acecinema
      SCYLLA_CONSISTENCY: ONE
      SCYLLA_RF: 1
      TMDB_API_KEY: ""
    depends_on:
      - scylla
    volumes:
      - /mnt/nfs/media:/mnt/media:ro

volumes:
  scylla1-data: {}
